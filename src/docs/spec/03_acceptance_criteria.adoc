:jbake-title: Acceptance Criteria
:jbake-type: page_toc
:jbake-status: published
:jbake-order: 3
ifndef::imagesdir[:imagesdir: ../../images]

:toc:

= MCP Documentation Server - Acceptance Criteria
:sectnums:
:icons: font

== Übersicht

Dieses Dokument definiert die Akzeptanzkriterien im Gherkin-Format (Given-When-Then).
Diese Szenarien können direkt als Basis für automatisierte Tests verwendet werden.

== Feature: Dokumentstruktur abrufen (UC-01)

[source,gherkin]
----
Feature: Dokumentstruktur abrufen
  Als LLM Client
  Möchte ich die hierarchische Struktur eines Dokumentationsprojekts abrufen
  Um einen Überblick über verfügbare Inhalte zu erhalten

  Background:
    Given der Server ist gestartet
    And das Projekt "test-docs" ist indiziert
    And das Projekt enthält folgende Struktur:
      | Pfad                  | Titel                |
      | introduction          | 1. Introduction      |
      | introduction.goals    | 1.1 Goals            |
      | introduction.scope    | 1.2 Scope            |
      | constraints           | 2. Constraints       |
      | constraints.technical | 2.1 Technical        |

  Scenario: Vollständige Struktur abrufen
    When ich GET /structure aufrufe
    Then erhalte ich HTTP Status 200
    And die Response enthält alle 5 Sektionen
    And die Struktur ist hierarchisch verschachtelt

  Scenario: Struktur mit Tiefenbegrenzung abrufen
    When ich GET /structure?max_depth=1 aufrufe
    Then erhalte ich HTTP Status 200
    And die Response enthält nur Sektionen der Ebene 1
    And "introduction" hat keine children
    And "constraints" hat keine children

  Scenario: Struktur bei leerem Projekt
    Given das Projekt enthält keine Dokumente
    When ich GET /structure aufrufe
    Then erhalte ich HTTP Status 200
    And die Response enthält eine leere Struktur
    And total_sections ist 0
----

== Feature: Sektion lesen (UC-02)

[source,gherkin]
----
Feature: Sektion lesen
  Als LLM Client
  Möchte ich den Inhalt einer spezifischen Sektion lesen
  Um gezielt auf Dokumentationsinhalte zuzugreifen

  Background:
    Given der Server ist gestartet
    And das Projekt "test-docs" ist indiziert
    And die Sektion "introduction.goals" existiert mit Inhalt:
      """
      == Goals
      
      The main goals are:
      * Goal 1
      * Goal 2
      """

  Scenario: Existierende Sektion lesen
    When ich GET /section/introduction.goals aufrufe
    Then erhalte ich HTTP Status 200
    And die Response enthält den vollständigen Sektionsinhalt
    And das Feld "path" ist "introduction.goals"
    And das Feld "format" ist "asciidoc"

  Scenario: Nicht existierende Sektion anfordern
    When ich GET /section/nonexistent.path aufrufe
    Then erhalte ich HTTP Status 404
    And der Fehlercode ist "PATH_NOT_FOUND"
    And die Fehlermeldung enthält "nonexistent.path"

  Scenario: Sektion mit URL-encodiertem Pfad lesen
    Given die Sektion "chapter-1.section-2" existiert
    When ich GET /section/chapter-1.section-2 aufrufe
    Then erhalte ich HTTP Status 200

  Scenario: Location-Informationen sind korrekt
    When ich GET /section/introduction.goals aufrufe
    Then enthält die Response ein "location" Objekt
    And "location.file" ist ein relativer Dateipfad
    And "location.start_line" ist größer als 0
    And "location.end_line" ist größer oder gleich "location.start_line"
----

== Feature: Sektion aktualisieren (UC-03)

[source,gherkin]
----
Feature: Sektion aktualisieren
  Als LLM Client
  Möchte ich den Inhalt einer Sektion aktualisieren
  Um Dokumentation zu pflegen und zu verbessern

  Background:
    Given der Server ist gestartet
    And das Projekt "test-docs" ist indiziert
    And die Sektion "introduction.goals" existiert
    And das Dateisystem ist beschreibbar

  Scenario: Sektion erfolgreich aktualisieren
    When ich PUT /section/introduction.goals aufrufe mit:
      """
      {
        "content": "== Goals\n\nUpdated goals content."
      }
      """
    Then erhalte ich HTTP Status 200
    And das Feld "success" ist true
    And der neue Inhalt ist in der Datei gespeichert
    And der Index ist aktualisiert

  Scenario: Titel beim Update beibehalten
    Given die Sektion hat den Titel "1.1 Goals"
    When ich PUT /section/introduction.goals aufrufe mit:
      """
      {
        "content": "New content without title",
        "preserve_title": true
      }
      """
    Then erhalte ich HTTP Status 200
    And der Titel "1.1 Goals" ist erhalten geblieben

  Scenario: Nicht existierende Sektion aktualisieren
    When ich PUT /section/nonexistent aufrufe mit:
      """
      {
        "content": "Some content"
      }
      """
    Then erhalte ich HTTP Status 404
    And der Fehlercode ist "PATH_NOT_FOUND"

  Scenario: Atomare Schreiboperation bei Fehler
    Given das Schreiben der temporären Datei schlägt fehl
    When ich PUT /section/introduction.goals aufrufe mit:
      """
      {
        "content": "New content"
      }
      """
    Then erhalte ich HTTP Status 500
    And der Fehlercode ist "WRITE_FAILED"
    And die Originaldatei ist unverändert
    And keine .tmp oder .bak Dateien verbleiben

  Scenario: Hash-Werte für Änderungsverfolgung
    When ich PUT /section/introduction.goals aufrufe mit gültigem content
    Then enthält die Response "previous_hash"
    And enthält die Response "new_hash"
    And "previous_hash" unterscheidet sich von "new_hash"
----

== Feature: Inhalt suchen (UC-04)

[source,gherkin]
----
Feature: Inhalt suchen
  Als LLM Client
  Möchte ich nach Inhalten im Dokumentationsprojekt suchen
  Um relevante Informationen schnell zu finden

  Background:
    Given der Server ist gestartet
    And das Projekt "test-docs" ist indiziert
    And das Projekt enthält Sektionen mit verschiedenen Inhalten

  Scenario: Erfolgreiche Suche mit Treffern
    Given eine Sektion enthält den Text "atomic write operation"
    When ich POST /search aufrufe mit:
      """
      {
        "query": "atomic write"
      }
      """
    Then erhalte ich HTTP Status 200
    And die Ergebnisliste enthält mindestens 1 Treffer
    And jeder Treffer hat einen "path"
    And jeder Treffer hat einen "context" mit dem Suchbegriff
    And jeder Treffer hat einen "score" zwischen 0 und 1

  Scenario: Suche ohne Treffer
    When ich POST /search aufrufe mit:
      """
      {
        "query": "xyznonexistentterm"
      }
      """
    Then erhalte ich HTTP Status 200
    And die Ergebnisliste ist leer
    And "total_results" ist 0

  Scenario: Suche mit Scope-Einschränkung
    When ich POST /search aufrufe mit:
      """
      {
        "query": "performance",
        "scope": "quality"
      }
      """
    Then erhalte ich HTTP Status 200
    And alle Treffer haben einen Pfad der mit "quality" beginnt

  Scenario: Case-sensitive Suche
    Given eine Sektion enthält "Performance" aber nicht "performance"
    When ich POST /search aufrufe mit:
      """
      {
        "query": "performance",
        "case_sensitive": true
      }
      """
    Then enthält die Ergebnisliste nicht die Sektion mit "Performance"

  Scenario: Ergebnisanzahl begrenzen
    Given es gibt mehr als 10 Treffer für "section"
    When ich POST /search aufrufe mit:
      """
      {
        "query": "section",
        "max_results": 5
      }
      """
    Then enthält die Ergebnisliste maximal 5 Treffer
----

== Feature: Elemente nach Typ filtern (UC-05)

[source,gherkin]
----
Feature: Elemente nach Typ filtern
  Als LLM Client
  Möchte ich Elemente eines bestimmten Typs abrufen
  Um gezielt auf Diagramme, Tabellen oder Code zuzugreifen

  Background:
    Given der Server ist gestartet
    And das Projekt "test-docs" ist indiziert
    And das Projekt enthält:
      | Typ     | Anzahl |
      | diagram | 5      |
      | table   | 8      |
      | code    | 12     |

  Scenario: Alle Diagramme abrufen
    When ich GET /elements?type=diagram aufrufe
    Then erhalte ich HTTP Status 200
    And das Feld "type" ist "diagram"
    And "count" ist 5
    And jedes Element hat einen "path"
    And jedes Element hat eine "location"

  Scenario: Tabellen einer bestimmten Sektion
    Given die Sektion "quality.performance" enthält 2 Tabellen
    When ich GET /elements?type=table&path=quality.performance aufrufe
    Then erhalte ich HTTP Status 200
    And "count" ist 2
    And alle Elemente haben path "quality.performance"

  Scenario: Ungültiger Elementtyp
    When ich GET /elements?type=charts aufrufe
    Then erhalte ich HTTP Status 400
    And der Fehlercode ist "INVALID_TYPE"
    And die Response enthält gültige Typen

  Scenario: Elementtyp ohne Treffer
    Given das Projekt enthält keine Bilder
    When ich GET /elements?type=image aufrufe
    Then erhalte ich HTTP Status 200
    And "count" ist 0
    And "elements" ist ein leeres Array
----

== Feature: Metadaten abrufen (UC-06)

[source,gherkin]
----
Feature: Metadaten abrufen
  Als LLM Client
  Möchte ich Metadaten über das Projekt oder Sektionen abrufen
  Um Informationen über Umfang und Aktualität zu erhalten

  Background:
    Given der Server ist gestartet
    And das Projekt "test-docs" ist indiziert

  Scenario: Projekt-Metadaten abrufen
    When ich GET /metadata aufrufe ohne path Parameter
    Then erhalte ich HTTP Status 200
    And die Response enthält "total_files"
    And die Response enthält "total_sections"
    And die Response enthält "total_words"
    And die Response enthält "last_modified" im ISO 8601 Format

  Scenario: Sektions-Metadaten abrufen
    When ich GET /metadata?path=introduction aufrufe
    Then erhalte ich HTTP Status 200
    And das Feld "path" ist "introduction"
    And die Response enthält "word_count"
    And die Response enthält "subsection_count"

  Scenario: Metadaten für nicht existierenden Pfad
    When ich GET /metadata?path=nonexistent aufrufe
    Then erhalte ich HTTP Status 404
----

== Feature: Struktur validieren (UC-07)

[source,gherkin]
----
Feature: Struktur validieren
  Als LLM Client
  Möchte ich die Dokumentstruktur auf Konsistenz prüfen
  Um Probleme frühzeitig zu erkennen

  Background:
    Given der Server ist gestartet
    And das Projekt "test-docs" ist indiziert

  Scenario: Valide Struktur prüfen
    Given das Projekt hat keine strukturellen Probleme
    When ich POST /validate aufrufe
    Then erhalte ich HTTP Status 200
    And "valid" ist true
    And "errors" ist ein leeres Array

  Scenario: Unaufgelöste Includes erkennen
    Given die Datei "chapter.adoc" enthält "include::missing.adoc[]"
    And die Datei "missing.adoc" existiert nicht
    When ich POST /validate aufrufe
    Then erhalte ich HTTP Status 200
    And "valid" ist false
    And "errors" enthält einen Eintrag mit type "unresolved_include"

  Scenario: Zirkuläre Includes erkennen
    Given Datei A inkludiert Datei B
    And Datei B inkludiert Datei A
    When ich POST /validate aufrufe
    Then erhalte ich HTTP Status 200
    And "valid" ist false
    And "errors" enthält einen Eintrag mit type "circular_include"

  Scenario: Verwaiste Dateien als Warnung
    Given die Datei "orphan.adoc" wird von keinem Dokument inkludiert
    When ich POST /validate aufrufe
    Then erhalte ich HTTP Status 200
    And "warnings" enthält einen Eintrag mit type "orphaned_file"
----

== Feature: Server-Initialisierung (UC-08)

[source,gherkin]
----
Feature: Server-Initialisierung
  Als System
  Muss ich beim Start das Dokumentationsprojekt indizieren
  Um schnelle Abfragen zu ermöglichen

  Scenario: Erfolgreiche Initialisierung
    Given das Projektverzeichnis enthält AsciiDoc-Dateien
    When der Server gestartet wird
    Then ist der Index nach dem Start aufgebaut
    And der Health-Endpunkt meldet "index_ready": true

  Scenario: Initialisierung mit leerem Verzeichnis
    Given das Projektverzeichnis ist leer
    When der Server gestartet wird
    Then startet der Server mit einem leeren Index
    And es wird eine Warnung geloggt

  Scenario: Fehlertolerante Initialisierung
    Given eine Datei im Projekt ist nicht parsebar
    When der Server gestartet wird
    Then wird die fehlerhafte Datei übersprungen
    And es wird ein Fehler geloggt
    And die anderen Dateien sind indiziert

  Scenario: Include-Auflösung während Initialisierung
    Given die Hauptdatei inkludiert drei Unterdateien
    When der Server gestartet wird
    Then sind alle inkludierten Sektionen im Index
    And die Include-Beziehungen sind erfasst
----

== Feature: Inhalt einfügen (UC-09)

[source,gherkin]
----
Feature: Inhalt einfügen
  Als LLM Client
  Möchte ich neuen Inhalt an einer bestimmten Position einfügen
  Um Dokumentation zu erweitern

  Background:
    Given der Server ist gestartet
    And das Projekt "test-docs" ist indiziert
    And die Sektion "introduction" existiert

  Scenario: Inhalt vor einer Sektion einfügen
    When ich POST /section/introduction/insert aufrufe mit:
      """
      {
        "position": "before",
        "content": "== Preface\n\nThis is a preface."
      }
      """
    Then erhalte ich HTTP Status 200
    And der neue Inhalt steht vor der Sektion "introduction"

  Scenario: Inhalt nach einer Sektion einfügen
    When ich POST /section/introduction/insert aufrufe mit:
      """
      {
        "position": "after",
        "content": "== Summary\n\nThis is a summary."
      }
      """
    Then erhalte ich HTTP Status 200
    And der neue Inhalt steht nach der Sektion "introduction"

  Scenario: Inhalt an Sektion anhängen
    When ich POST /section/introduction/insert aufrufe mit:
      """
      {
        "position": "append",
        "content": "\n\nAdditional paragraph."
      }
      """
    Then erhalte ich HTTP Status 200
    And der neue Inhalt ist am Ende der Sektion "introduction"

  Scenario: Ungültige Position
    When ich POST /section/introduction/insert aufrufe mit:
      """
      {
        "position": "invalid",
        "content": "Some content"
      }
      """
    Then erhalte ich HTTP Status 400
    And der Fehlercode ist "INVALID_POSITION"
----

== Feature: Element ersetzen (UC-10)

[source,gherkin]
----
Feature: Element ersetzen
  Als LLM Client
  Möchte ich ein spezifisches Element innerhalb einer Sektion ersetzen
  Um gezielt Tabellen, Code-Blöcke oder Diagramme zu aktualisieren

  Background:
    Given der Server ist gestartet
    And das Projekt "test-docs" ist indiziert
    And die Sektion "quality.performance" enthält eine Tabelle an Index 0

  Scenario: Tabelle erfolgreich ersetzen
    When ich PUT /element/quality.performance/0 aufrufe mit:
      """
      {
        "content": "[cols=\"1,2\"]\n|===\n| New | Table\n|==="
      }
      """
    Then erhalte ich HTTP Status 200
    And "success" ist true
    And die Tabelle in der Datei ist aktualisiert

  Scenario: Element an ungültigem Index
    When ich PUT /element/quality.performance/99 aufrufe mit:
      """
      {
        "content": "New content"
      }
      """
    Then erhalte ich HTTP Status 404
    And der Fehlercode ist "ELEMENT_NOT_FOUND"

  Scenario: Element in nicht existierender Sektion
    When ich PUT /element/nonexistent/0 aufrufe mit:
      """
      {
        "content": "New content"
      }
      """
    Then erhalte ich HTTP Status 404
    And der Fehlercode ist "PATH_NOT_FOUND"
----

== Feature: Non-Functional Requirements

[source,gherkin]
----
Feature: Performance-Anforderungen
  Als System
  Muss ich bestimmte Performance-Kriterien erfüllen

  Scenario: Schnelle Antwortzeiten für Leseoperationen
    Given ein Projekt mit 600 Seiten ist indiziert
    When ich GET /section/some.path aufrufe
    Then ist die Antwortzeit unter 2 Sekunden

  Scenario: Akzeptable Indexierungszeit
    Given ein Projekt mit 600 Seiten
    When der Server gestartet wird
    Then ist die Indexierung in unter 60 Sekunden abgeschlossen

  Scenario: Geringer Idle-Ressourcenverbrauch
    Given der Server ist gestartet und idle
    When keine Anfragen eingehen für 60 Sekunden
    Then ist die CPU-Auslastung unter 5%
    And der Speicherverbrauch ist stabil
----

[source,gherkin]
----
Feature: Reliability-Anforderungen
  Als System
  Muss ich Datenintegrität gewährleisten

  Scenario: Atomare Schreiboperationen
    Given eine Schreiboperation ist in Bearbeitung
    When ein Fehler während des Schreibens auftritt
    Then ist die Originaldatei unverändert
    And es verbleiben keine temporären Dateien

  Scenario: Graceful Error Handling
    Given eine Datei ist nicht lesbar
    When ich GET /section/path.to.file aufrufe
    Then erhalte ich HTTP Status 500
    And die Fehlermeldung ist aussagekräftig
    And der Server bleibt stabil
----

== Traceability Matrix

[cols="1,2,2"]
|===
| Use-Case | API-Endpunkte | Akzeptanzszenarien

| UC-01 | GET /structure, GET /sections | 3 Szenarien
| UC-02 | GET /section/{path} | 4 Szenarien
| UC-03 | PUT /section/{path} | 5 Szenarien
| UC-04 | POST /search | 5 Szenarien
| UC-05 | GET /elements | 4 Szenarien
| UC-06 | GET /metadata, GET /dependencies | 3 Szenarien
| UC-07 | POST /validate | 4 Szenarien
| UC-08 | (System-Startup) | 4 Szenarien
| UC-09 | POST /section/{path}/insert | 4 Szenarien
| UC-10 | PUT /element/{path}/{index} | 3 Szenarien
|===

== Anhang: Test-Daten-Spezifikation

=== Minimales Test-Projekt

[source]
----
test-docs/
├── arc42.adoc           # Hauptdokument mit includes
├── chapters/
│   ├── 01_introduction.adoc
│   ├── 02_constraints.adoc
│   └── 03_context.adoc
└── images/
    └── diagram.png
----

=== Struktur der Test-Dokumente

[source,asciidoc]
----
// arc42.adoc
= Test Documentation

\include::chapters/01_introduction.adoc[]
\include::chapters/02_constraints.adoc[]
\include::chapters/03_context.adoc[]
----

[source,asciidoc]
----
// chapters/01_introduction.adoc
== Introduction

=== Goals

The goals are...

=== Scope

The scope includes...
----
